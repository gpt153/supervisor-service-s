# Instruction Management System

The instruction management system provides a layered approach to managing supervisor instructions across all projects in the SV system.

## Overview

Each supervisor has a `CLAUDE.md` file that is **auto-generated** from multiple instruction layers. This ensures consistency across projects while allowing project-specific customizations.

## Layer Architecture

Instructions are assembled from three layers (in order):

### 1. Core Layer (`.supervisor-core/`)

**Location**: `/home/samuel/sv/supervisor-service/.supervisor-core/`

**Shared by**: All projects

**Purpose**: Common instructions for all supervisors

**Files**:
- `01-identity.md` - Generic supervisor identity and role
- `02-workflow.md` - Standard operating procedures
- `03-structure.md` - Directory structure guidance
- `04-tools.md` - Available commands and tools

**When to Update**:
- Changes that apply to ALL supervisors
- New shared commands or tools
- Updates to standard workflows

### 2. Meta Layer (`.supervisor-meta/`)

**Location**: `/home/samuel/sv/supervisor-service/.supervisor-meta/`

**Used by**: Only `supervisor-service`

**Purpose**: Meta-infrastructure specific instructions

**Files**:
- `00-meta-identity.md` - Meta supervisor identity override
- `01-meta-focus.md` - Infrastructure focus areas
- `02-dependencies.md` - Technology stack
- `03-patterns.md` - Code patterns and standards

**When to Update**:
- Changes specific to supervisor-service infrastructure
- Database schema guidance
- MCP server patterns

### 3. Project Layer (`.supervisor-specific/`)

**Location**: `/home/samuel/sv/<project>/.supervisor-specific/`

**Used by**: Each individual project

**Purpose**: Project-specific context and constraints

**Files**:
- `01-project-context.md` - Project identity, tech stack, features
- Additional numbered files as needed

**When to Update**:
- Project-specific requirements change
- Tech stack updates
- New features or constraints

## File Naming Convention

All instruction files use numbered prefixes to control order:

```
01-first-section.md
02-second-section.md
10-later-section.md
```

Files are assembled in alphabetical order, so numbering ensures consistent ordering.

## Auto-Generation Process

The `CLAUDE.md` file is **auto-generated** and should **never be edited directly**.

### Assembly Process

1. Load core instructions from `supervisor-service/.supervisor-core/`
2. Load meta instructions from `supervisor-service/.supervisor-meta/` (if exists)
3. Load project-specific instructions from project's `.supervisor-specific/`
4. Combine in order with metadata header
5. Write to `CLAUDE.md`

### Metadata Header

Each generated `CLAUDE.md` includes a header:

```markdown
<!-- AUTO-GENERATED CLAUDE.md -->
<!-- Do not edit this file directly. Edit source files in: -->
<!--   - /path/to/source1.md
  - /path/to/source2.md -->
<!-- Generated: 2026-01-18T12:00:00.000Z -->
```

## Using the System

### Update Shared Instructions (Core Layer)

Use the MCP tool or manual edit:

```typescript
// Via MCP tool
mcp__meta__update_core_instruction({
  filename: "01-identity.md",
  content: "# New content...",
  layer: "core",
  regenerateAll: true // Regenerate all projects
})
```

Or manually:

```bash
# Edit the file
vim /home/samuel/sv/supervisor-service/.supervisor-core/01-identity.md

# Regenerate all projects
npm run init-projects
```

### Update Project-Specific Instructions

```bash
# Edit project-specific file
vim /home/samuel/sv/consilio/.supervisor-specific/01-project-context.md

# Regenerate that project
npm run init-projects -- --project consilio
```

### Create New Instruction Layer

```bash
# Create new file in appropriate layer
echo "# New Section" > /home/samuel/sv/supervisor-service/.supervisor-core/05-new-section.md

# Regenerate projects
npm run init-projects
```

## Commands and Scripts

### Initialize/Update All Projects

```bash
npm run init-projects
```

Regenerates `CLAUDE.md` for all projects using current instructions.

Options:
- `--dry-run` - Show what would happen without writing files
- `--project <name>` - Only process specific project
- `--verbose` - Detailed output

### Watch Planning Files

```bash
npm run watch:planning
```

Automatically regenerates `CLAUDE.md` when planning files change:
- `.bmad/epics/*.md`
- `.bmad/adrs/*.md`
- `.supervisor-specific/*.md`

Options:
- `--project <name>` - Only watch specific project

### Regenerate Supervisor-Service

```bash
npm run regenerate
```

Regenerates `supervisor-service/CLAUDE.md` using core + meta layers.

### Verify System

```bash
npm run verify
```

Verifies instruction system integrity:
- All layers have required files
- No orphaned files
- Metadata headers are correct

## MCP Tools

### List Projects

```typescript
mcp__meta__list_projects({
  includeDetails: true
})
```

Returns all projects with their status.

### Regenerate Supervisor

```typescript
mcp__meta__regenerate_supervisor({
  project: "consilio", // Optional, omit for all
  dryRun: false,
  preserveProjectSpecific: true
})
```

Regenerates CLAUDE.md for one or all projects.

### Update Core Instruction

```typescript
mcp__meta__update_core_instruction({
  filename: "01-identity.md",
  content: "# New content...",
  layer: "core", // or "meta"
  regenerateAll: true
})
```

Updates a core instruction file and optionally regenerates all projects.

### Read Core Instruction

```typescript
mcp__meta__read_core_instruction({
  filename: "01-identity.md",
  layer: "core"
})
```

Reads a core instruction file.

### List Core Instructions

```typescript
mcp__meta__list_core_instructions({
  layer: "all" // or "core" or "meta"
})
```

Lists all instruction files in specified layer(s).

## Automatic Regeneration

### When Does It Happen?

Automatic regeneration occurs when:

1. **Core instructions updated** - Via MCP tool with `regenerateAll: true`
2. **Planning files changed** - When `npm run watch:planning` is running
3. **Manual trigger** - Via `npm run init-projects`

### Debouncing

The watch script debounces changes by 2 seconds to avoid excessive regenerations during rapid file editing.

## Best Practices

### DO

✓ Edit source files in `.supervisor-core/`, `.supervisor-meta/`, or `.supervisor-specific/`
✓ Use numbered prefixes for consistent ordering
✓ Run `npm run init-projects` after manual edits
✓ Use `--dry-run` to preview changes
✓ Keep project-specific instructions focused on that project
✓ Document major changes in commit messages

### DON'T

✗ Edit `CLAUDE.md` directly (it will be overwritten)
✗ Mix concerns between layers (keep core generic, meta infrastructure-focused, project specific)
✗ Delete numbered files without updating others (creates gaps)
✗ Make breaking changes to core without testing all projects

## Troubleshooting

### CLAUDE.md is out of sync

```bash
npm run init-projects
```

### Changes not appearing

1. Check you edited the source file, not `CLAUDE.md`
2. Verify file is in correct layer directory
3. Run regeneration manually
4. Check for errors in console output

### Project missing sections

1. Verify `.supervisor-specific/` directory exists
2. Check files have `.md` extension
3. Ensure files are properly formatted markdown
4. Check metadata header for source file paths

### Watch script not working

1. Ensure `.bmad/` directory exists
2. Check file permissions
3. Verify Node.js version (20+)
4. Check console for error messages

## Migration from Old System

If you have existing `CLAUDE.md` files:

1. Run `npm run init-projects` - It will extract project-specific sections
2. Review generated `.supervisor-specific/` files
3. Verify `CLAUDE.md` has correct content
4. Commit the new structure

The system automatically preserves content marked with:

```markdown
<!-- project-specific:start -->
Content here
<!-- project-specific:end -->
```

## Architecture Decisions

See relevant ADRs:
- `EPIC-008-instruction-management.md` - System design
- Planning artifacts in `/home/samuel/sv/.bmad/`

## Related Documentation

- [README.md](../README.md) - Service overview
- [DEVELOPMENT.md](./DEVELOPMENT.md) - Development guide
- [MCP_TOOLS.md](./MCP_TOOLS.md) - MCP tool reference
