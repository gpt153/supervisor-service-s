# Instruction Management System

This directory contains the instruction assembly system for generating CLAUDE.md files.

## Overview

The instruction system uses a layered approach to combine multiple sources of instructions into a single CLAUDE.md file:

1. **Core Instructions** (`.supervisor-core/`) - Shared across all supervisors
2. **Meta-Specific Instructions** (`.supervisor-meta/`) - Specific to meta/supervisor-service
3. **Project-Specific Instructions** (`.claude-specific/`) - Preserved project customizations

## Architecture

```
InstructionAssembler
├── loadLayer() - Load markdown files from a layer directory
├── assemble() - Combine all layers into final content
├── assembleAndWrite() - Assemble and write to file
├── extractProjectSpecific() - Extract project sections from existing CLAUDE.md
├── saveProjectSpecific() - Save project sections to .claude-specific/
└── regenerate() - Full regeneration with preservation
```

## Usage

### Generate CLAUDE.md

```bash
# From supervisor-service directory
npm run assemble

# With options
tsx src/scripts/assemble-claude.ts --output /path/to/CLAUDE.md --verbose
```

### Regenerate (Preserve Project Content)

```bash
# From supervisor-service directory
npm run regenerate

# With options
tsx src/scripts/regenerate-claude.ts --target /path/to/CLAUDE.md --verbose
```

### Programmatic Usage

```typescript
import { InstructionAssembler } from './InstructionAssembler.js';

const assembler = new InstructionAssembler('/home/samuel/sv/supervisor-service');

// Simple assembly
const result = await assembler.assembleAndWrite('./CLAUDE.md', {
  includeMetadata: true,
});

// Regenerate with preservation
const result = await assembler.regenerate('./CLAUDE.md');
```

## Layer Structure

### Core Instructions (.supervisor-core/)

Files loaded in alphabetical order:
- `01-identity.md` - Supervisor identity and role
- `02-workflow.md` - Standard operating procedures
- `03-structure.md` - Directory organization
- `04-tools.md` - Available tools and commands

### Meta-Specific (.supervisor-meta/)

Files loaded in alphabetical order:
- `01-meta-focus.md` - Meta-specific focus areas
- `02-dependencies.md` - Technology stack and dependencies
- `03-patterns.md` - Code patterns and conventions

### Project-Specific (.claude-specific/)

Automatically extracted and saved during regeneration:
- Sections marked with `<!-- project-specific:start -->` and `<!-- project-specific:end -->`
- Saved as `section-1.md`, `section-2.md`, etc.

## Adding New Instructions

### To Core (Affects All Supervisors)

1. Create new `.md` file in `.supervisor-core/`
2. Use numeric prefix for ordering (e.g., `05-new-section.md`)
3. Run `npm run assemble` to regenerate CLAUDE.md
4. Test with supervisor to ensure no issues

### To Meta-Specific

1. Create new `.md` file in `.supervisor-meta/`
2. Use numeric prefix for ordering (e.g., `04-new-section.md`)
3. Run `npm run assemble` to regenerate CLAUDE.md

### Project-Specific Sections

Wrap sections in markers:

```markdown
<!-- project-specific:start -->
## My Custom Section

Custom content here...
<!-- project-specific:end -->
```

Then run `npm run regenerate` to preserve during updates.

## Best Practices

1. **Ordering**: Use numeric prefixes (01-, 02-, etc.) for consistent ordering
2. **Modularity**: Keep each file focused on a single topic
3. **Clarity**: Write for AI agent consumption (clear, structured, actionable)
4. **Testing**: Always test generated CLAUDE.md with actual supervisor
5. **Version Control**: Commit instruction changes separately from code changes

## Metadata

Generated CLAUDE.md files include metadata header:

```markdown
<!-- AUTO-GENERATED CLAUDE.md -->
<!-- Do not edit this file directly. Edit source files in: -->
<!-- /home/samuel/sv/supervisor-service/.supervisor-core/01-identity.md -->
<!-- /home/samuel/sv/supervisor-service/.supervisor-meta/01-meta-focus.md -->
<!-- Generated: 2026-01-18T12:00:00.000Z -->
```

This helps identify:
- File is auto-generated (don't edit directly)
- Source files for each section
- When it was last generated

## Error Handling

The assembler handles:
- Missing layer directories (skips gracefully)
- Empty directories (no sections added)
- Invalid markdown (passes through as-is)
- File system errors (throws with helpful message)

## Future Enhancements

Planned features (see EPIC-008):
- MCP tools for remote regeneration
- AdaptLocalClaude agent for automatic updates
- Automatic triggers (epic complete, PR merge, monthly)
- Git commit integration
- Diff preview before regeneration
